# 🔌 УПРАВЛЕНИЕ ЭЛЕКТРОПИТАНИЕМ ПЕРИФЕРИИ

## 📋 Концепция системы

### 🔧 Схема подключения:
```
RPi GPIO 26 → Оптопара → Реле 220В → Розетки → [Усилитель, HDD, др.]
     ↑           ↑           ↑           ↑
  Управление  Развязка   Коммутация   Периферия
```

**⚠️ ВАЖНОЕ ИЗМЕНЕНИЕ:** GPIO изменен на 26 (pin 37) - надежная работа с Python RPi.GPIO!

### ⚡ Принцип работы:
1. **При включении RPi** → GPIO HIGH (3.3V) → Оптопара → Транзистор → Реле 5V → Питание подается
2. **При выключении RPi** → GPIO LOW (0V) → Реле размыкается → Питание отключается

## 🛠️ Техническая реализация

### 📦 Компоненты системы:

#### 1. **Реле управления (5В)**
- ⚠️ **ВНИМАНИЕ**: Большинство реле работает от 5В, а RPi выдаёт 3.3В!
- Необходима схема усиления сигнала (см. СХЕМА_РЕЛЕ_5В.md)
- Номинальный ток нагрузки: 10-16А
- Контакты: нормально разомкнутые (NO)

#### 2. **Схема усиления сигнала**
- **Оптопара**: PC817 (гальваническая развязка)
- **Транзистор**: 2N2222 или BC547 (усиление до 5V)
- **Резисторы**: 330Ом (ограничение тока), 1кОм (подтяжка)
- **Диод**: 1N4007 (защита от обратного тока)

#### 3. **GPIO управление**
- Пин: **GPIO 26 (физический pin 37)**
- Логика: HIGH (3.3V) = включено, LOW (0V) = выключено
- Управление: Python скрипт с библиотекой RPi.GPIO

## 🔧 Установка и настройка

### 1. Физическое подключение:
```
RPi GPIO 26 → Резистор 330Ом → Оптопара PC817 → Транзистор 2N2222 → Реле 5В
Реле контакты → Линия 220В → Розетки периферии
```

**⚠️ ВНИМАНИЕ:** 
- GPIO изменен на 26 (pin 37) для стабильной работы
- Добавлена схема усиления сигнала (подробности в СХЕМА_РЕЛЕ_5В.md)
- RPi выдаёт 3.3V, а реле требует 5V!

### 2. Программная настройка:
```bash
# Установка Python скрипта управления
sudo chmod +x power-control.py

# Тестирование GPIO (без подключенного реле)
sudo python3 power-control.py test

# Включение питания
sudo python3 power-control.py on

# Проверка состояния
sudo python3 power-control.py status
```
# Установка системы управления питанием
cd /home/eu/aether-player
chmod +x setup-power-management.sh
./setup-power-management.sh
```

### 3. Интеграция с системой:
```bash
# Автозапуск с управлением питанием
sudo systemctl enable aether-power.service
sudo systemctl start aether-power.service
```

## 🎛️ Управление

### 🖥️ Через веб-интерфейс:
```
http://IP_ADDRESS:5000/monitor
```
- Статус питания в разделе мониторинга
- Кнопки включения/выключения периферии

### 💻 Через командную строку:
```bash
# Включить питание
./power-control.sh on

# Безопасно выключить (с отмонтированием HDD)
./power-control.sh safe-off

# Проверить статус
./power-control.sh status

# Тестирование реле
./power-control.sh test
```

### 🔧 Через systemd:
```bash
# Включить питание
sudo systemctl start aether-power

# Выключить питание
sudo systemctl stop aether-power

# Статус
sudo systemctl status aether-power
```

## ⚡ Логика автоматизации

### 🚀 При включении системы:
1. RPi загружается
2. Служба `aether-power` запускается
3. GPIO 18 устанавливается в HIGH
4. Реле замыкается → Питание подается на периферию
5. Ожидание стабилизации (3 сек)
6. Монтирование HDD
7. Запуск Aether Player

### 🛑 При выключении системы:
1. Команда выключения
2. Остановка Aether Player
3. Отмонтирование HDD с синхронизацией
3. GPIO 18 устанавливается в LOW → **ИЗМЕНЕНО: GPIO 21**
5. Реле размыкается → Питание отключается
6. Выключение RPi

## 🔒 Безопасность

### ✅ Преимущества решения:
- **Гальваническая развязка** через оптопару
- **Автоматическое управление** без вмешательства пользователя
- **Безопасное отключение** с отмонтированием дисков
- **Энергосбережение** - полное отключение неиспользуемого оборудования
- **Защита от скачков** - управляемое включение после стабилизации

### ⚠️ Меры предосторожности:
- Используйте реле с достаточным номинальным током
- Обеспечьте качественные соединения 220В
- Установите предохранители на линии периферии
- Проверяйте изоляцию проводов

## 🧪 Тестирование

### 1. Тест GPIO:
```bash
# Проверка инициализации
./power-control.sh init

# Проверка управления
./power-control.sh test
```

### 2. Проверка реле:
```bash
# Мультиметром проверить замыкание/размыкание контактов
# При GPIO HIGH - контакты замкнуты
# При GPIO LOW - контакты разомкнуты
```

### 3. Тест нагрузки:
```bash
# Подключить нагрузку (лампу) через реле
# Проверить включение/выключение
./power-control.sh on   # Лампа должна загореться
./power-control.sh off  # Лампа должна погаснуть
```

## 📊 Мониторинг

### Веб-интерфейс покажет:
- 🟢 **Питание включено** - GPIO HIGH, реле замкнуто
- 🔴 **Питание выключено** - GPIO LOW, реле разомкнуто
- ❌ **Ошибка** - проблемы с GPIO или конфигурацией

### Логи системы:
```bash
# Логи управления питанием
journalctl -u aether-power -f

# Системные логи
tail -f /var/log/syslog | grep "Aether Player"
```

## 🔧 Альтернативные улучшения

### 1. **Многоканальное реле**:
- Отдельные каналы для усилителя и HDD
- Раздельное управление устройствами
- Последовательное включение/выключение

### 2. **Мониторинг потребления**:
- Токовые датчики на каждой линии
- Контроль мощности через web-интерфейс
- Автоматическое отключение при перегрузке

### 3. **UPS интеграция**:
- Подключение к ИБП
- Мониторинг состояния батареи
- Автоматическое безопасное выключение при разряде

### 4. **Умные розетки**:
- WiFi управляемые розетки
- Индивидуальное управление каждым устройством
- Мониторинг потребления по устройствам

## ⚙️ Схема монтажа

```
┌─────────────────────────────────────────────────────────────┐
│                    Raspberry Pi                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ GPIO 18 (pin 12) ──→ 220Ω ──→ Оптопара PC817      │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────────────┐
        │              Реле 220В (10А)                    │
        │  Управление: 5В DC от оптопары                 │
        │  Контакты: 220В AC коммутация                  │
        └─────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────────────┐
        │            Розетки периферии                    │
        │  ┌─────────────┐ ┌─────────────┐ ┌──────────┐  │
        │  │ Усилитель   │ │ Внешний HDD │ │ Другие   │  │
        │  │ звука       │ │             │ │ устр-ва  │  │
        │  └─────────────┘ └─────────────┘ └──────────┘  │
        └─────────────────────────────────────────────────┘
```

---
**⚡ Автоматическое управление питанием обеспечивает безопасность, удобство и энергоэффективность!**
