# 🔌 УПРАВЛЕНИЕ ЭЛЕКТРОПИТАНИЕМ ПЕРИФЕРИИ

## 📋 Концепция системы

### 🔧 Схема подключения:
```
RPi GPIO 21 → Оптопара → Реле 220В → Розетки → [Усилитель, HDD, др.]
     ↑           ↑           ↑           ↑
  Управление  Развязка   Коммутация   Периферия
```

**⚠️ ВАЖНОЕ ИЗМЕНЕНИЕ:** GPIO изменен с 18 на 21 из-за конфликта PWM!

### ⚡ Принцип работы:
1. **При включении RPi** → GPIO HIGH → Реле замыкается → Питание подается
2. **При выключении RPi** → GPIO LOW → Реле размыкается → Питание отключается

## 🛠️ Техническая реализация

### 📦 Компоненты системы:

#### 1. **Реле управления (220В)**
- Номинальный ток: 10-16А (под нагрузку)
- Управляющее напряжение: 5В DC
- Контакты: нормально разомкнутые (NO)

#### 2. **Оптопара (гальваническая развязка)**
- Тип: PC817 или аналог
- Назначение: защита RPi от помех 220В
- Управление: GPIO 18 (pin 12)

#### 3. **GPIO управление**
- Пин: GPIO 21 (физический pin 40) ⚠️ ИЗМЕНЕНО!
- Старый пин GPIO 18 недоступен из-за конфликта PWM
- Логика: HIGH = включено, LOW = выключено
- Защита: через резистор 220Ом

## 🔧 Установка и настройка

### 1. Физическое подключение:
```
RPi GPIO 21 → Резистор 220Ом → Оптопара вход
Оптопара выход → Реле управляющая обмотка
Реле контакты → Линия 220В → Розетки периферии
```

**⚠️ ВНИМАНИЕ:** Подключение изменено с GPIO 18 (pin 12) на GPIO 21 (pin 40)

### 2. Программная настройка:
```bash
# Установка системы управления питанием
cd /home/eu/aether-player
chmod +x setup-power-management.sh
./setup-power-management.sh
```

### 3. Интеграция с системой:
```bash
# Автозапуск с управлением питанием
sudo systemctl enable aether-power.service
sudo systemctl start aether-power.service
```

## 🎛️ Управление

### 🖥️ Через веб-интерфейс:
```
http://IP_ADDRESS:5000/monitor
```
- Статус питания в разделе мониторинга
- Кнопки включения/выключения периферии

### 💻 Через командную строку:
```bash
# Включить питание
./power-control.sh on

# Безопасно выключить (с отмонтированием HDD)
./power-control.sh safe-off

# Проверить статус
./power-control.sh status

# Тестирование реле
./power-control.sh test
```

### 🔧 Через systemd:
```bash
# Включить питание
sudo systemctl start aether-power

# Выключить питание
sudo systemctl stop aether-power

# Статус
sudo systemctl status aether-power
```

## ⚡ Логика автоматизации

### 🚀 При включении системы:
1. RPi загружается
2. Служба `aether-power` запускается
3. GPIO 18 устанавливается в HIGH
4. Реле замыкается → Питание подается на периферию
5. Ожидание стабилизации (3 сек)
6. Монтирование HDD
7. Запуск Aether Player

### 🛑 При выключении системы:
1. Команда выключения
2. Остановка Aether Player
3. Отмонтирование HDD с синхронизацией
3. GPIO 18 устанавливается в LOW → **ИЗМЕНЕНО: GPIO 21**
5. Реле размыкается → Питание отключается
6. Выключение RPi

## 🔒 Безопасность

### ✅ Преимущества решения:
- **Гальваническая развязка** через оптопару
- **Автоматическое управление** без вмешательства пользователя
- **Безопасное отключение** с отмонтированием дисков
- **Энергосбережение** - полное отключение неиспользуемого оборудования
- **Защита от скачков** - управляемое включение после стабилизации

### ⚠️ Меры предосторожности:
- Используйте реле с достаточным номинальным током
- Обеспечьте качественные соединения 220В
- Установите предохранители на линии периферии
- Проверяйте изоляцию проводов

## 🧪 Тестирование

### 1. Тест GPIO:
```bash
# Проверка инициализации
./power-control.sh init

# Проверка управления
./power-control.sh test
```

### 2. Проверка реле:
```bash
# Мультиметром проверить замыкание/размыкание контактов
# При GPIO HIGH - контакты замкнуты
# При GPIO LOW - контакты разомкнуты
```

### 3. Тест нагрузки:
```bash
# Подключить нагрузку (лампу) через реле
# Проверить включение/выключение
./power-control.sh on   # Лампа должна загореться
./power-control.sh off  # Лампа должна погаснуть
```

## 📊 Мониторинг

### Веб-интерфейс покажет:
- 🟢 **Питание включено** - GPIO HIGH, реле замкнуто
- 🔴 **Питание выключено** - GPIO LOW, реле разомкнуто
- ❌ **Ошибка** - проблемы с GPIO или конфигурацией

### Логи системы:
```bash
# Логи управления питанием
journalctl -u aether-power -f

# Системные логи
tail -f /var/log/syslog | grep "Aether Player"
```

## 🔧 Альтернативные улучшения

### 1. **Многоканальное реле**:
- Отдельные каналы для усилителя и HDD
- Раздельное управление устройствами
- Последовательное включение/выключение

### 2. **Мониторинг потребления**:
- Токовые датчики на каждой линии
- Контроль мощности через web-интерфейс
- Автоматическое отключение при перегрузке

### 3. **UPS интеграция**:
- Подключение к ИБП
- Мониторинг состояния батареи
- Автоматическое безопасное выключение при разряде

### 4. **Умные розетки**:
- WiFi управляемые розетки
- Индивидуальное управление каждым устройством
- Мониторинг потребления по устройствам

## ⚙️ Схема монтажа

```
┌─────────────────────────────────────────────────────────────┐
│                    Raspberry Pi                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ GPIO 18 (pin 12) ──→ 220Ω ──→ Оптопара PC817      │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────────────┐
        │              Реле 220В (10А)                    │
        │  Управление: 5В DC от оптопары                 │
        │  Контакты: 220В AC коммутация                  │
        └─────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────────────┐
        │            Розетки периферии                    │
        │  ┌─────────────┐ ┌─────────────┐ ┌──────────┐  │
        │  │ Усилитель   │ │ Внешний HDD │ │ Другие   │  │
        │  │ звука       │ │             │ │ устр-ва  │  │
        │  └─────────────┘ └─────────────┘ └──────────┘  │
        └─────────────────────────────────────────────────┘
```

---
**⚡ Автоматическое управление питанием обеспечивает безопасность, удобство и энергоэффективность!**
