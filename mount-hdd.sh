#!/bin/bash

# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ HDD Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
# Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ° Aether Player
# UPDATED: 2025-08-06 v2 - Graceful startup Ğ±ĞµĞ· HDD

echo "ğŸ”§ ĞœĞ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ HDD Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Aether Player..."

# Ğ–Ğ´ĞµĞ¼, Ğ¿Ğ¾ĞºĞ° Ğ´Ğ¸ÑĞº ÑÑ‚Ğ°Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ (Ğ²Ğ°Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ!)
echo "â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ¸ÑĞºĞ°..."
for i in {1..30}; do
    if lsblk | grep -q "sda2"; then
        echo "âœ… Ğ”Ğ¸ÑĞº sda2 Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ Ñ‡ĞµÑ€ĞµĞ· $i ÑĞµĞºÑƒĞ½Ğ´"
        break
    fi
    echo "   ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° $i/30: Ğ´Ğ¸ÑĞº Ğ½Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ², Ğ¶Ğ´ĞµĞ¼..."
    sleep 2
done

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½ Ğ»Ğ¸ Ğ´Ğ¸ÑĞº
if ! lsblk | grep -q "sda2"; then
    echo "âš ï¸  HDD Ğ½Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½ (sda2 Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ´Ğ°Ğ¶Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ)"
    echo "ğŸ” Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ´Ğ¸ÑĞºĞ¸:"
    lsblk
    echo ""
    echo "ğŸŒ Aether Player Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑÑ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ 'HDD Ğ½Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½'"
    echo "   ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒĞ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ² Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞµ"
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»-Ñ„Ğ»Ğ°Ğ³ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
    echo "HDD_NOT_CONNECTED" > /tmp/aether-hdd-status.txt
    echo "$(date)" >> /tmp/aether-hdd-status.txt
    
    # ĞĞµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ÑÑ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹ - Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ°Ñ‚ÑŒ!
    exit 0
fi

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
sudo mkdir -p /mnt/hdd

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ ÑĞ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ´Ğ¸ÑĞº
if ! mountpoint -q /mnt/hdd; then
    echo "ğŸ“€ ĞœĞ¾Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ HDD..."
    if sudo mount /dev/sda2 /mnt/hdd; then
        echo "âœ… HDD ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"
    else
        echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ HDD"
        exit 1
    fi
else
    echo "âœ… HDD ÑƒĞ¶Ğµ ÑĞ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ¿Ğ°Ğ¿ĞºĞµ Ñ Ğ¼ÑƒĞ·Ñ‹ĞºĞ¾Ğ¹
if [ -d "/mnt/hdd/MUSIC" ]; then
    echo "ğŸµ ĞŸĞ°Ğ¿ĞºĞ° MUSIC Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
    ls -la /mnt/hdd/MUSIC | head -3
else
    echo "âš ï¸ ĞŸĞ°Ğ¿ĞºĞ° MUSIC Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°, ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼..."
    sudo mkdir -p /mnt/hdd/MUSIC
fi

# Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
sudo chmod 755 /mnt/hdd
sudo chmod -R 755 /mnt/hdd/MUSIC 2>/dev/null || true

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»-Ñ„Ğ»Ğ°Ğ³ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¼ Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸
echo "HDD_CONNECTED" > /tmp/aether-hdd-status.txt
echo "$(date)" >> /tmp/aether-hdd-status.txt
echo "/mnt/hdd" >> /tmp/aether-hdd-status.txt

echo "âœ… HDD Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ!"
echo "ğŸ“ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸:"
ls -la /mnt/hdd/ | grep '^d'

echo ""
echo "ğŸŒ Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ http://$(hostname -I | awk '{print $1}'):5000"
