#!/bin/bash

# –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ Aether Player (v2.0)
# –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–ª–µ 220–í —á–µ—Ä–µ–∑ GPIO –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è —É—Å–∏–ª–∏—Ç–µ–ª—è, HDD –∏ –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ libgpiod —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è Raspberry Pi 4+

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
POWER_GPIO=18          # GPIO –ø–∏–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ª–µ
GPIO_CHIP="gpiochip0"  # GPIO —á–∏–ø (–æ—Å–Ω–æ–≤–Ω–æ–π –Ω–∞ RPi 4)

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è GPIO
check_gpio() {
    gpioget $GPIO_CHIP $POWER_GPIO 2>/dev/null
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ GPIO –≤ HIGH (–≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–ª–µ)
gpio_high() {
    gpioset $GPIO_CHIP $POWER_GPIO=1
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ GPIO –≤ LOW (–≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–ª–µ) 
gpio_low() {
    gpioset $GPIO_CHIP $POWER_GPIO=0
}

# –§—É–Ω–∫—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏
power_on() {
    echo "‚ö° –í–∫–ª—é—á–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏..."
    
    # –í–∫–ª—é—á–∞–µ–º —Ä–µ–ª–µ (HIGH)
    gpio_high
    sleep 0.5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    STATE=$(check_gpio)
    if [ "$STATE" = "1" ]; then
        echo "‚úÖ –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤–∫–ª—é—á–µ–Ω–æ"
        echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ: –í–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = HIGH)"
        logger "Aether Player: –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤–∫–ª—é—á–µ–Ω–æ"
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ"
        echo "üìä GPIO $POWER_GPIO = $STATE (–æ–∂–∏–¥–∞–ª–æ—Å—å 1)"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏
power_off() {
    echo "‚ö†Ô∏è –í—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏..."
    
    # –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–ª–µ (LOW)
    gpio_low
    sleep 0.5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    STATE=$(check_gpio)
    if [ "$STATE" = "0" ]; then
        echo "‚úÖ –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ"
        echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ: –í–´–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = LOW)"
        logger "Aether Player: –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ"
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ"
        echo "üìä GPIO $POWER_GPIO = $STATE (–æ–∂–∏–¥–∞–ª–æ—Å—å 0)"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
status() {
    echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º:"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    STATE=$(check_gpio)
    if [ $? -eq 0 ]; then
        case "$STATE" in
            "1")
                echo "üü¢ –†–µ–ª–µ: –í–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = HIGH)"
                echo "‚ö° –ü–µ—Ä–∏—Ñ–µ—Ä–∏—è: –ü–ò–¢–ê–ù–ò–ï –ü–û–î–ê–ù–û"
                ;;
            "0")
                echo "üî¥ –†–µ–ª–µ: –í–´–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = LOW)"
                echo "üö´ –ü–µ—Ä–∏—Ñ–µ—Ä–∏—è: –ü–ò–¢–ê–ù–ò–ï –û–¢–ö–õ–Æ–ß–ï–ù–û"
                ;;
            *)
                echo "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: $STATE"
                ;;
        esac
    else
        echo "‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è GPIO $POWER_GPIO"
        echo "üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å GPIO –∏–ª–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞"
    fi
    
    echo ""
    echo "üîß –£–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
    echo "  ‚Ä¢ –£—Å–∏–ª–∏—Ç–µ–ª—å –∑–≤—É–∫–∞"
    echo "  ‚Ä¢ –í–Ω–µ—à–Ω–∏–π HDD"
    echo "  ‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è"
    
    echo ""
    echo "üí° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ GPIO:"
    gpioinfo | grep "line.*$POWER_GPIO:" || echo "‚ùå GPIO $POWER_GPIO –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
}

# –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º HDD
safe_power_off() {
    echo "üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Aether Player
    echo "üéµ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Aether Player..."
    sudo pkill -f "python.*app" 2>/dev/null || true
    sudo pkill -f mpv 2>/dev/null || true
    sleep 2
    
    # –û—Ç–º–æ–Ω—Ç–∏—Ä—É–µ–º HDD
    echo "üíæ –û—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–µ–π..."
    
    # –ò—â–µ–º –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ USB –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–∏
    USB_MOUNTS=$(mount | grep "/dev/sd" | awk '{print $1}' | sort -u)
    if [ ! -z "$USB_MOUNTS" ]; then
        for DEVICE in $USB_MOUNTS; do
            echo "üì§ –û—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ $DEVICE..."
            sudo umount "$DEVICE" 2>/dev/null || true
        done
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
        echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã..."
        sync
        sleep 2
    else
        echo "‚ÑπÔ∏è –í–Ω–µ—à–Ω–∏–µ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã"
    fi
    
    # –í—ã–∫–ª—é—á–∞–µ–º –ø–∏—Ç–∞–Ω–∏–µ
    power_off
    
    echo "‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
}

# –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ª–µ
test_relay() {
    echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º..."
    echo ""
    
    echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:"
    status
    echo ""
    
    echo "2Ô∏è‚É£ –¢–µ—Å—Ç –≤–∫–ª—é—á–µ–Ω–∏—è:"
    power_on
    sleep 2
    echo ""
    
    echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è:"
    status
    echo ""
    
    echo "4Ô∏è‚É£ –¢–µ—Å—Ç –≤—ã–∫–ª—é—á–µ–Ω–∏—è:"
    power_off
    sleep 2
    echo ""
    
    echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –≤—ã–∫–ª—é—á–µ–Ω–∏—è:"
    status
    echo ""
    
    echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º—É–ª—å—Ç–∏–º–µ—Ç—Ä–æ–º —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Ä–µ–ª–µ"
}

# –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
init() {
    echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ GPIO —Å–∏—Å—Ç–µ–º—ã..."
    echo "üì° –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ libgpiod"
    echo "üéØ GPIO —á–∏–ø: $GPIO_CHIP"
    echo "üìå GPIO –ø–∏–Ω: $POWER_GPIO"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å GPIO
    STATE=$(check_gpio)
    if [ $? -eq 0 ]; then
        echo "‚úÖ GPIO $POWER_GPIO –¥–æ—Å—Ç—É–ø–µ–Ω (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: $STATE)"
    else
        echo "‚ùå GPIO $POWER_GPIO –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        echo "üîß –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç –≤ –≥—Ä—É–ø–ø—É 'gpio'"
        echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ: sudo usermod -a -G gpio $USER"
        return 1
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
case "$1" in
    "on"|"enable"|"start")
        power_on
        ;;
    "off"|"disable"|"stop")
        power_off
        ;;
    "safe-off"|"safe-stop")
        safe_power_off
        ;;
    "status"|"state"|"check")
        status
        ;;
    "test"|"debug")
        test_relay
        ;;
    "init"|"setup")
        init
        ;;
    *)
        echo "üîå –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º Aether Player v2.0"
        echo ""
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {–ö–û–ú–ê–ù–î–ê}"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  on, enable, start     - –í–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏"
        echo "  off, disable, stop    - –í—ã–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏" 
        echo "  safe-off, safe-stop   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å —Å –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º HDD"
        echo "  status, state, check  - –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
        echo "  test, debug          - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É"
        echo "  init, setup          - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é GPIO"
        echo ""
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  $0 on      # –í–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ"
        echo "  $0 status  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
        echo "  $0 test    # –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ª–µ"
        echo ""
        exit 1
        ;;
esac
