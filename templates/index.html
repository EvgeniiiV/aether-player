<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aether Player</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–º */
        :root {
            --bg-primary: #222;
            --bg-secondary: #2a2a2a;
            --bg-hover: #383838;
            --bg-controls: #111;
            --text-primary: #eee;
            --text-secondary: #ccc;
            --text-link: #8af;
            --border-color: #444;
            --cue-track-number: #4488ff;
            --cue-track-title: #333;
        }

        body.light-theme {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-hover: #e8e8e8;
            --bg-controls: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #444;
            --text-link: #0066cc;
            --border-color: #ddd;
            --cue-track-number: #0066cc;
            --cue-track-title: #1a1a1a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            max-width: 900px;
            margin: 20px auto;
            padding-bottom: 150px;
            transition: background-color 0.3s, color 0.3s;
        }
        a { color: var(--text-link); text-decoration: none; }
        a:hover { text-decoration: underline; }
        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 10px; display: flex; align-items: center; padding: 10px; border-radius: 5px; }
        li:nth-child(odd) { background-color: var(--bg-secondary); }
        li:hover { background-color: var(--bg-hover); }
        .icon { margin-right: 15px; font-size: 1.2em; }
        .action-button { margin-left: auto; background: #4a4; border: none; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; }
        .action-button.view-button { background-color: #44c; }
        .action-button.text-button { background-color: #c84; }
        button.action-button.play-button.playing {
            background-color: #8a4 !important;
            box-shadow: 0 0 10px rgba(136, 170, 68, 0.6) !important;
            border: 2px solid #9b5 !important;
            font-weight: bold !important;
        }
        #upload-section, #create-folder-section { background-color: var(--bg-secondary); padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        #now-playing-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-controls); padding: 15px; border-top: 1px solid var(--border-color); box-sizing: border-box; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); transition: background-color 0.3s, border-color 0.3s; }
        .controls { display: flex; gap: 15px; align-items: center; }
        .control-button { background: #44c; border: none; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1.2em; }
        #progress-container, #volume-container { width: 80%; max-width: 800px; display: flex; align-items: center; gap: 10px; }
        .slider { flex-grow: 1; width: 100%; cursor: pointer; }
        #progress-bar { 
            cursor: pointer; 
            height: 15px; 
            -webkit-appearance: none;
            appearance: none;
            background: #333; 
            border-radius: 10px;
            overflow: hidden;
            outline: none;
        }
        #progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4488ff;
            cursor: pointer;
            border: none;
            box-shadow: -410px 0 0 400px #4488ff;
        }
        #progress-bar::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4488ff;
            cursor: pointer;
            border: none;
            box-shadow: -410px 0 0 400px #4488ff;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è touch-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (pointer: coarse) {
            #progress-bar::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }
            #progress-bar::-moz-range-thumb {
                width: 24px;
                height: 24px;
            }
            #progress-bar {
                height: 24px;
            }
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è CUE –∞–ª—å–±–æ–º–æ–≤ */
        .cue-album-container {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border-radius: 5px;
            border-left: 4px solid var(--cue-track-number);
            transition: background-color 0.3s;
        }
        .cue-album-title {
            margin-top: 0;
            color: var(--cue-track-number);
        }
        .cue-album-item-title {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--cue-track-title);
            margin-bottom: 5px;
        }
        .cue-track-number {
            font-weight: bold;
            color: var(--cue-track-number);
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h1>Aether Player</h1>
        <div style="display: flex; gap: 10px;">
            <button id="settings-button" class="control-button" style="background-color: #f59e0b; text-decoration: none; font-size: 0.9em;">
                ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            <a href="/audio-settings" class="control-button" style="background-color: #6a4c93; text-decoration: none; font-size: 0.9em;">
                üéµ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ
            </a>
            <a href="/monitor" class="control-button" style="background-color: #667eea; text-decoration: none; font-size: 0.9em;" target="_blank">
                üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            </a>
        </div>
    </div>
    <h3>–¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞: /{{ current_subpath }}</h3>

    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–æ–∫ -->
    <div id="create-folder-section">
        <form id="create-folder-form">
            <input type="text" id="new-folder-name" placeholder="–ò–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏" required>
            <button type="submit">–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
        </form>
    </div>

    <!-- –§–∞–π–ª–æ–≤—ã–π –±—Ä–∞—É–∑–µ—Ä -->
    <ul>
        {% if parent_path is not none %}
        <li><span class="icon">‚§¥Ô∏è</span> <a href="{{ url_for('browse', subpath=parent_path) }}">.. (–ù–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ)</a></li>
        {% endif %}
        {% for folder in folders %}
        <li><span class="icon">üìÅ</span> <a href="{{ url_for('browse', subpath=current_subpath + '/' + folder if current_subpath else folder) }}">{{ folder }}</a></li>
        {% endfor %}
        {% for file in files %}
        <li>
            {% set file_path = current_subpath + '/' + file if current_subpath else file %}
            {% if file.lower().endswith(('.jpg', '.jpeg', '.png')) %} 
                <span class="icon">üñºÔ∏è</span>
                <span>{{ file }}</span>
                <!-- –û–ë–ù–û–í–õ–ï–ù–ò–ï: –°–Ω–æ–≤–∞ –∫–Ω–æ–ø–∫–∞, –∞ –Ω–µ —Å—Å—ã–ª–∫–∞ -->
                <button class="action-button view-button" data-filepath="{{ file_path }}">üëÅÔ∏è View</button>
            {% elif file.lower().endswith(('.txt', '.log', '.nfo', '.md', '.readme', '.info', '.cue', '.m3u', '.pls')) %}
                <span class="icon">üìÑ</span>
                <span>{{ file }}</span>
                <button class="action-button text-button" data-filepath="{{ file_path }}">üìñ –ß–∏—Ç–∞—Ç—å</button>
            {% else %}
                {% if file.lower().endswith(('.mkv', '.mp4', '.avi')) %} <span class="icon">üé¨</span> {% else %} <span class="icon">üéµ</span> {% endif %}
                <span>{{ file }}</span>
                <button class="action-button play-button" data-filepath="{{ file_path }}">‚ñ∂Ô∏è Play</button>
            {% endif %}
        </li>
        {% endfor %}
    </ul>

    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è CUE-–∞–ª—å–±–æ–º–æ–≤ -->
    {% if cue_albums %}
    <div class="cue-album-container">
        <h3 class="cue-album-title">üéº –ê–ª—å–±–æ–º—ã (CUE)</h3>
        {% for album in cue_albums %}
        <div style="margin-bottom: 15px; padding: 10px; background-color: var(--bg-hover); border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div class="cue-album-item-title">
                {{ album.title }}
            </div>
            <div style="color: #666; font-size: 0.9em; margin-bottom: 10px;">
                –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {{ album.performer }} | –¢—Ä–µ–∫–æ–≤: {{ album.total_tracks }}
            </div>
            <div style="margin-bottom: 10px;">
                <button class="action-button" onclick="toggleTracks('album-{{ loop.index }}')">
                    üìã –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–∫–∏
                </button>
                <button class="action-button play-button" data-filepath="{{ (current_subpath + '/' + album.audio_file) if current_subpath else album.audio_file }}" style="background-color: #28a745;">
                    ‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≤–µ—Å—å –∞–ª—å–±–æ–º
                </button>
            </div>
            <div id="album-{{ loop.index }}" style="display: none; margin-top: 10px;">
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 3px;">
                    {% for track in album.tracks %}
                    <div style="padding: 8px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <span class="cue-track-number">{{ "%02d"|format(track.number) }}.</span>
                            <span style="font-weight: 500; color: var(--text-primary);">{{ track.title }}</span>
                            {% if track.performer and track.performer != album.performer %}
                                <span style="color: #666; font-size: 0.9em;"> - {{ track.performer }}</span>
                            {% endif %}
                            {% if track.start_time %}
                                <span style="color: #888; font-size: 0.8em; margin-left: 10px;">[{{ track.start_time }}]</span>
                            {% endif %}
                        </div>
                        <button class="action-button play-button" 
                                data-filepath="{{ (current_subpath + '/' + track.file) if current_subpath else track.file }}"
                                data-start-time="{{ track.relative_time_seconds }}"
                                data-track-id="cue-{{ loop.index0 }}-{{ track.number }}"
                                style="background-color: #17a2b8; font-size: 0.8em; padding: 4px 8px;">
                            ‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <div id="upload-section">
        <h4>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –≤ —Ç–µ–∫—É—â—É—é –ø–∞–ø–∫—É</h4>
        <form id="upload-form">
            <input type="file" id="file-input" multiple>
            <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </form>
        <div id="upload-progress-container"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∞ -->
    <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: var(--bg-secondary); padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∞</h2>
                <button id="close-settings" style="background: #e74c3c; border: none; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 1.2em;">‚úï</button>
            </div>

            <!-- –¢–µ–º–∞ -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px;">üé® –¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h3>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; padding: 15px; border: 2px solid var(--border-color); border-radius: 5px; cursor: pointer; text-align: center;">
                        <input type="radio" name="ui-theme" value="dark" style="margin-right: 5px;">
                        <span>üåô –¢–µ–º–Ω–∞—è</span>
                    </label>
                    <label style="flex: 1; padding: 15px; border: 2px solid var(--border-color); border-radius: 5px; cursor: pointer; text-align: center;">
                        <input type="radio" name="ui-theme" value="light" style="margin-right: 5px;">
                        <span>‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</span>
                    </label>
                </div>
            </div>

            <!-- –†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ HDMI -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px;">üñ•Ô∏è –†–µ–∂–∏–º HDMI –º–æ–Ω–∏—Ç–æ—Ä–∞</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="padding: 12px; border: 2px solid var(--border-color); border-radius: 5px; cursor: pointer; display: flex; align-items: center;">
                        <input type="radio" name="display-mode" value="full" style="margin-right: 10px;">
                        <div>
                            <div style="font-weight: bold;">üñºÔ∏è –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
                            <div style="font-size: 0.85em; opacity: 0.7;">–¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</div>
                        </div>
                    </label>
                    <label style="padding: 12px; border: 2px solid var(--border-color); border-radius: 5px; cursor: pointer; display: flex; align-items: center;">
                        <input type="radio" name="display-mode" value="split" style="margin-right: 10px;" checked>
                        <div>
                            <div style="font-weight: bold;">üìä –†–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω</div>
                            <div style="font-size: 0.85em; opacity: 0.7;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ + –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–∫–µ</div>
                        </div>
                    </label>
                    <label style="padding: 12px; border: 2px solid var(--border-color); border-radius: 5px; cursor: pointer; display: flex; align-items: center;">
                        <input type="radio" name="display-mode" value="info" style="margin-right: 10px;">
                        <div>
                            <div style="font-weight: bold;">üìã –¢–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                            <div style="font-size: 0.85em; opacity: 0.7;">–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω —Å –¥–µ—Ç–∞–ª—è–º–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- –¢–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∞ -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px;">üé® –¢–µ–º–∞ HDMI –º–æ–Ω–∏—Ç–æ—Ä–∞</h3>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; padding: 15px; border: 2px solid var(--border-color); border-radius: 5px; cursor: pointer; text-align: center;">
                        <input type="radio" name="monitor-theme" value="dark" style="margin-right: 5px;" checked>
                        <span>üåô –¢–µ–º–Ω–∞—è</span>
                    </label>
                    <label style="flex: 1; padding: 15px; border: 2px solid var(--border-color); border-radius: 5px; cursor: pointer; text-align: center;">
                        <input type="radio" name="monitor-theme" value="light" style="margin-right: 5px;">
                        <span>‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</span>
                    </label>
                </div>
            </div>

            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º -->
            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px;">üñºÔ∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º</h3>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="prev-image" class="control-button" style="flex: 1; padding: 15px; font-size: 1.1em;">‚óÄÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–µ–µ</button>
                    <button id="next-image" class="control-button" style="flex: 1; padding: 15px; font-size: 1.1em;">‚ñ∂Ô∏è –°–ª–µ–¥—É—é—â–µ–µ</button>
                </div>
                <div id="image-info" style="text-align: center; margin-top: 10px; opacity: 0.7; font-size: 0.9em;">
                    –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                </div>
            </div>
        </div>
    </div>

    <!-- –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
    <div id="now-playing-bar">
        <div style="display: flex; justify-content: space-between; width: 100%; max-width: 800px;">
            <div id="now-playing-info"><strong>–°—Ç–∞—Ç—É—Å:</strong> –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
            <div id="audio-enhancement-info" style="color: #8af;"><strong>–°—Ç–µ—Ä–µ–æ:</strong> <span id="current-preset">–í—ã–∫–ª—é—á–µ–Ω–æ</span></div>
        </div>
        <div id="progress-container">
            <span id="current-time" data-time="0">00:00</span>
            <input type="range" id="progress-bar" class="slider" value="0" min="0" max="100" step="0.1">
            <span id="total-time" data-time="0">00:00</span>
        </div>
        <div class="controls">
            <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê PREVIOUS -->
            <button class="control-button" id="prev-button">‚èÆÔ∏è</button>
            <button class="control-button" id="play-pause-button">‚ñ∂Ô∏è</button>
            <button class="control-button" id="stop-button">‚èπÔ∏è</button>
            <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê NEXT -->
            <button class="control-button" id="next-button">‚è≠Ô∏è</button>
        </div>
        <div id="volume-container">
            <input type="range" id="volume-slider" class="slider" value="100" min="0" max="100">
            <span id="volume-percent">100%</span>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SocketIO –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        let socket = null;
        try {
            socket = io();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—É–¥–∏–æ-–ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏
            socket.on('audio_enhancement_changed', function(data) {
                const presetElement = document.getElementById('current-preset');
                if (presetElement && data.preset_info) {
                    presetElement.textContent = data.preset_info.name;
                }
            });
        } catch (e) {
            console.log('SocketIO –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ç—Ä–µ–∫–æ–≤ –∞–ª—å–±–æ–º–∞
        function toggleTracks(albumId) {
            const trackList = document.getElementById(albumId);
            const button = event.target;

            if (trackList.style.display === 'none') {
                trackList.style.display = 'block';
                button.textContent = 'üìã –°–∫—Ä—ã—Ç—å —Ç—Ä–µ–∫–∏';
            } else {
                trackList.style.display = 'none';
                button.textContent = 'üìã –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–∫–∏';
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∞
        (function() {
            const settingsButton = document.getElementById('settings-button');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettings = document.getElementById('close-settings');
            const body = document.body;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É UI –∏–∑ localStorage
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                body.classList.add('light-theme');
                document.querySelector('input[name="ui-theme"][value="light"]').checked = true;
            } else {
                document.querySelector('input[name="ui-theme"][value="dark"]').checked = true;
            }

            // –û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            settingsButton.addEventListener('click', function() {
                settingsModal.style.display = 'flex';
                updateImageInfo();
            });

            closeSettings.addEventListener('click', function() {
                settingsModal.style.display = 'none';
            });

            // –ó–∞–∫—Ä—ã—Ç—å –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            settingsModal.addEventListener('click', function(e) {
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });

            // –°–º–µ–Ω–∞ —Ç–µ–º—ã UI
            document.querySelectorAll('input[name="ui-theme"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'light') {
                        body.classList.add('light-theme');
                        localStorage.setItem('theme', 'light');
                    } else {
                        body.classList.remove('light-theme');
                        localStorage.setItem('theme', 'dark');
                    }
                });
            });

            // –°–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è HDMI
            document.querySelectorAll('input[name="display-mode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    fetch('/api/monitor/set_mode', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({mode: this.value})
                    })
                    .then(r => r.json())
                    .then(data => {
                        console.log('–†–µ–∂–∏–º –º–æ–Ω–∏—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω:', data);
                    })
                    .catch(err => console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞:', err));
                });
            });

            // –°–º–µ–Ω–∞ —Ç–µ–º—ã HDMI –º–æ–Ω–∏—Ç–æ—Ä–∞
            document.querySelectorAll('input[name="monitor-theme"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    fetch('/api/monitor/set_theme', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({theme: this.value})
                    })
                    .then(r => r.json())
                    .then(data => {
                        console.log('–¢–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∞:', data);
                    })
                    .catch(err => console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ç–µ–º—ã:', err));
                });
            });

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
            document.getElementById('prev-image').addEventListener('click', function() {
                fetch('/api/monitor/navigate_image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({direction: 'prev'})
                })
                .then(r => r.json())
                .then(data => {
                    console.log('–ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é:', data);
                    updateImageInfo();
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:', err));
            });

            document.getElementById('next-image').addEventListener('click', function() {
                fetch('/api/monitor/navigate_image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({direction: 'next'})
                })
                .then(r => r.json())
                .then(data => {
                    console.log('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é:', data);
                    updateImageInfo();
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:', err));
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö
            function updateImageInfo() {
                fetch('/api/monitor/state')
                    .then(r => r.json())
                    .then(data => {
                        const gallery = data.monitor.image_gallery;
                        const index = data.monitor.current_image_index;
                        const infoDiv = document.getElementById('image-info');

                        if (gallery && gallery.length > 0) {
                            const imageName = gallery[index].split('/').pop();
                            infoDiv.textContent = `${index + 1} / ${gallery.length}: ${imageName}`;
                        } else {
                            infoDiv.textContent = '–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π';
                        }
                    })
                    .catch(err => console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', err));
            }
        })();
    </script>
    <script src="{{ url_for('static', filename='script_new.js') }}"></script>
</body>
</html>