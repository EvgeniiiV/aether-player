#!/bin/bash

# –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ Aether Player
# –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–ª–µ 220–í —á–µ—Ä–µ–∑ GPIO –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è —É—Å–∏–ª–∏—Ç–µ–ª—è, HDD –∏ –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
POWER_GPIO=18          # GPIO –ø–∏–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ª–µ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
GPIO_PATH="/sys/class/gpio"
POWER_PIN_PATH="$GPIO_PATH/gpio$POWER_GPIO"

# –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GPIO
init_gpio() {
    echo "üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GPIO –ø–∏–Ω–∞ $POWER_GPIO –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º..."
    
    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º GPIO –µ—Å–ª–∏ –µ—â–µ –Ω–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
    if [ ! -d "$POWER_PIN_PATH" ]; then
        echo "$POWER_GPIO" | sudo tee "$GPIO_PATH/export" > /dev/null
        sleep 0.5
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤—ã—Ö–æ–¥)
    echo "out" | sudo tee "$POWER_PIN_PATH/direction" > /dev/null
    
    echo "‚úÖ GPIO $POWER_GPIO –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
}

# –§—É–Ω–∫—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏
power_on() {
    echo "‚ö° –í–∫–ª—é—á–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏..."
    init_gpio
    
    # –í–∫–ª—é—á–∞–µ–º —Ä–µ–ª–µ (HIGH)
    echo "1" | sudo tee "$POWER_PIN_PATH/value" > /dev/null
    
    echo "‚úÖ –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤–∫–ª—é—á–µ–Ω–æ"
    echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ: –í–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = HIGH)"
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
    logger "Aether Player: –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤–∫–ª—é—á–µ–Ω–æ"
}

# –§—É–Ω–∫—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏
power_off() {
    echo "‚ö†Ô∏è –í—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ GPIO
    if [ ! -d "$POWER_PIN_PATH" ]; then
        echo "‚ùå GPIO –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
        return 1
    fi
    
    # –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–ª–µ (LOW)
    echo "0" | sudo tee "$POWER_PIN_PATH/value" > /dev/null
    
    echo "‚úÖ –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ"
    echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ: –í–´–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = LOW)"
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
    logger "Aether Player: –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
status() {
    echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º:"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    if [ -d "$POWER_PIN_PATH" ]; then
        STATE=$(cat "$POWER_PIN_PATH/value" 2>/dev/null)
        case "$STATE" in
            "1")
                echo "üü¢ –†–µ–ª–µ: –í–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = HIGH)"
                echo "‚ö° –ü–µ—Ä–∏—Ñ–µ—Ä–∏—è: –ü–ò–¢–ê–ù–ò–ï –ü–û–î–ê–ù–û"
                ;;
            "0")
                echo "üî¥ –†–µ–ª–µ: –í–´–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = LOW)"
                echo "üö´ –ü–µ—Ä–∏—Ñ–µ—Ä–∏—è: –ü–ò–¢–ê–ù–ò–ï –û–¢–ö–õ–Æ–ß–ï–ù–û"
                ;;
            *)
                echo "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: $STATE"
                ;;
        esac
    else
        echo "‚ùå GPIO $POWER_GPIO –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
    fi
    
    echo ""
    echo "üîß –£–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
    echo "  ‚Ä¢ –£—Å–∏–ª–∏—Ç–µ–ª—å –∑–≤—É–∫–∞"
    echo "  ‚Ä¢ –í–Ω–µ—à–Ω–∏–π HDD"
    echo "  ‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è"
}

# –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º HDD
safe_power_off() {
    echo "üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Aether Player
    echo "üéµ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Aether Player..."
    sudo pkill -f "python.*app" 2>/dev/null || true
    sudo pkill -f mpv 2>/dev/null || true
    
    # –û—Ç–º–æ–Ω—Ç–∏—Ä—É–µ–º HDD
    echo "üíæ –û—Ç–º–æ–Ω—Ç–∏—Ä—É–µ–º HDD..."
    if mountpoint -q /mnt/hdd; then
        sync  # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        sudo umount /mnt/hdd
        if [ $? -eq 0 ]; then
            echo "‚úÖ HDD —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω"
        else
            echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è HDD"
        fi
    else
        echo "‚ÑπÔ∏è HDD —É–∂–µ –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω"
    fi
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π (3 —Å–µ–∫)..."
    sleep 3
    
    # –í—ã–∫–ª—é—á–∞–µ–º –ø–∏—Ç–∞–Ω–∏–µ
    power_off
    
    echo "‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
}

# –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ª–µ
test_relay() {
    echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ª–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º..."
    
    init_gpio
    
    echo "üìù –¢–µ—Å—Ç 1: –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–ª–µ –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã"
    power_on
    sleep 2
    
    echo "üìù –¢–µ—Å—Ç 2: –í—ã–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–ª–µ –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã"
    power_off
    sleep 2
    
    echo "üìù –¢–µ—Å—Ç 3: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ"
    power_on
    
    echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
}

# –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
case "$1" in
    "on"|"start"|"enable")
        power_on
        ;;
    "off"|"stop"|"disable")
        power_off
        ;;
    "safe-off"|"safe-stop")
        safe_power_off
        ;;
    "status"|"state")
        status
        ;;
    "test")
        test_relay
        ;;
    "init")
        init_gpio
        ;;
    *)
        echo "üîå –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º Aether Player"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–∫–æ–º–∞–Ω–¥–∞]"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  on, start, enable    - –í–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏"
        echo "  off, stop, disable   - –í—ã–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏"
        echo "  safe-off, safe-stop  - –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Å –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º HDD"
        echo "  status, state        - –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"
        echo "  test                 - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Ä–µ–ª–µ"
        echo "  init                 - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å GPIO"
        echo ""
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  $0 on              # –í–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ"
        echo "  $0 safe-off        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å"
        echo "  $0 status          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
        echo ""
        exit 1
        ;;
esac
