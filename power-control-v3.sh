#!/bin/bash

# –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ Aether Player (v3.0)
# –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–ª–µ 220–í —á–µ—Ä–µ–∑ GPIO –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è —É—Å–∏–ª–∏—Ç–µ–ª—è, HDD –∏ –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç sysfs –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —É–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è GPIO

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
POWER_GPIO=18
GPIO_PATH="/sys/class/gpio"
POWER_PIN_PATH="$GPIO_PATH/gpio$POWER_GPIO"

# –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GPIO
init_gpio() {
    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º GPIO –µ—Å–ª–∏ –µ—â–µ –Ω–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
    if [ ! -d "$POWER_PIN_PATH" ]; then
        echo "üîß –≠–∫—Å–ø–æ—Ä—Ç GPIO $POWER_GPIO..."
        echo "$POWER_GPIO" | sudo tee "$GPIO_PATH/export" > /dev/null
        sleep 0.5
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤—ã—Ö–æ–¥)
    if [ -f "$POWER_PIN_PATH/direction" ]; then
        echo "üì§ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GPIO $POWER_GPIO –∫–∞–∫ –≤—ã—Ö–æ–¥..."
        echo "out" | sudo tee "$POWER_PIN_PATH/direction" > /dev/null
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GPIO"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è GPIO
check_gpio() {
    if [ -f "$POWER_PIN_PATH/value" ]; then
        cat "$POWER_PIN_PATH/value" 2>/dev/null
    else
        echo "‚ùå GPIO –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ GPIO –≤ HIGH (–≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–ª–µ)
gpio_high() {
    init_gpio
    echo "1" | sudo tee "$POWER_PIN_PATH/value" > /dev/null
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ GPIO –≤ LOW (–≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–ª–µ) 
gpio_low() {
    if [ -f "$POWER_PIN_PATH/value" ]; then
        echo "0" | sudo tee "$POWER_PIN_PATH/value" > /dev/null
    fi
}

# –§—É–Ω–∫—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏
power_on() {
    echo "‚ö° –í–∫–ª—é—á–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏..."
    
    # –í–∫–ª—é—á–∞–µ–º —Ä–µ–ª–µ (HIGH)
    gpio_high
    sleep 0.5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    STATE=$(check_gpio)
    if [ "$STATE" = "1" ]; then
        echo "‚úÖ –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤–∫–ª—é—á–µ–Ω–æ"
        echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ: –í–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = HIGH)"
        logger "Aether Player: –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤–∫–ª—é—á–µ–Ω–æ"
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ"
        echo "üìä GPIO $POWER_GPIO = $STATE (–æ–∂–∏–¥–∞–ª–æ—Å—å 1)"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏
power_off() {
    echo "‚ö†Ô∏è –í—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏..."
    
    # –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–ª–µ (LOW)
    gpio_low
    sleep 0.5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    STATE=$(check_gpio)
    if [ "$STATE" = "0" ]; then
        echo "‚úÖ –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ"
        echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ: –í–´–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = LOW)"
        logger "Aether Player: –ü–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ"
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ"
        echo "üìä GPIO $POWER_GPIO = $STATE (–æ–∂–∏–¥–∞–ª–æ—Å—å 0)"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
status() {
    echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º:"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    if [ -d "$POWER_PIN_PATH" ]; then
        STATE=$(check_gpio)
        if [ $? -eq 0 ]; then
            case "$STATE" in
                "1")
                    echo "üü¢ –†–µ–ª–µ: –í–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = HIGH)"
                    echo "‚ö° –ü–µ—Ä–∏—Ñ–µ—Ä–∏—è: –ü–ò–¢–ê–ù–ò–ï –ü–û–î–ê–ù–û"
                    ;;
                "0")
                    echo "üî¥ –†–µ–ª–µ: –í–´–ö–õ–Æ–ß–ï–ù–û (GPIO $POWER_GPIO = LOW)"
                    echo "üö´ –ü–µ—Ä–∏—Ñ–µ—Ä–∏—è: –ü–ò–¢–ê–ù–ò–ï –û–¢–ö–õ–Æ–ß–ï–ù–û"
                    ;;
                *)
                    echo "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: $STATE"
                    ;;
            esac
        else
            echo "‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è GPIO $POWER_GPIO"
        fi
    else
        echo "‚ùå GPIO $POWER_GPIO –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
        echo "üí° –í—ã–ø–æ–ª–Ω–∏—Ç–µ: $0 init"
    fi
    
    echo ""
    echo "üîß –£–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
    echo "  ‚Ä¢ –£—Å–∏–ª–∏—Ç–µ–ª—å –∑–≤—É–∫–∞"
    echo "  ‚Ä¢ –í–Ω–µ—à–Ω–∏–π HDD"
    echo "  ‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è"
    
    echo ""
    echo "üí° –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
    echo "  üìÇ GPIO –ø—É—Ç—å: $POWER_PIN_PATH"
    echo "  üîå GPIO –ø–∏–Ω: $POWER_GPIO (—Ñ–∏–∑–∏—á–µ—Å–∫–∏–π pin 12)"
    
    if [ -d "$POWER_PIN_PATH" ]; then
        echo "  üì§ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: $(cat $POWER_PIN_PATH/direction 2>/dev/null || echo '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')"
        echo "  üìä –ó–Ω–∞—á–µ–Ω–∏–µ: $(cat $POWER_PIN_PATH/value 2>/dev/null || echo '–Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ')"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º HDD
safe_power_off() {
    echo "üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Aether Player
    echo "üéµ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Aether Player..."
    sudo pkill -f "python.*app" 2>/dev/null || true
    sudo pkill -f mpv 2>/dev/null || true
    sleep 2
    
    # –û—Ç–º–æ–Ω—Ç–∏—Ä—É–µ–º HDD
    echo "üíæ –û—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–µ–π..."
    
    # –ò—â–µ–º –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ USB –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–∏
    USB_MOUNTS=$(mount | grep "/dev/sd" | awk '{print $1}' | sort -u)
    if [ ! -z "$USB_MOUNTS" ]; then
        for DEVICE in $USB_MOUNTS; do
            echo "üì§ –û—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ $DEVICE..."
            sudo umount "$DEVICE" 2>/dev/null || true
        done
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
        echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã..."
        sync
        sleep 2
    else
        echo "‚ÑπÔ∏è –í–Ω–µ—à–Ω–∏–µ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã"
    fi
    
    # –í—ã–∫–ª—é—á–∞–µ–º –ø–∏—Ç–∞–Ω–∏–µ
    power_off
    
    echo "‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
}

# –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ª–µ
test_relay() {
    echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º..."
    echo ""
    
    echo "1Ô∏è‚É£ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GPIO:"
    init_gpio
    echo ""
    
    echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:"
    status
    echo ""
    
    echo "3Ô∏è‚É£ –¢–µ—Å—Ç –≤–∫–ª—é—á–µ–Ω–∏—è:"
    power_on
    sleep 2
    echo ""
    
    echo "4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è:"
    STATE=$(check_gpio)
    echo "üìä GPIO $POWER_GPIO = $STATE"
    echo ""
    
    echo "5Ô∏è‚É£ –¢–µ—Å—Ç –≤—ã–∫–ª—é—á–µ–Ω–∏—è:"
    power_off
    sleep 2
    echo ""
    
    echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –≤—ã–∫–ª—é—á–µ–Ω–∏—è:"
    STATE=$(check_gpio)
    echo "üìä GPIO $POWER_GPIO = $STATE"
    echo ""
    
    echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º—É–ª—å—Ç–∏–º–µ—Ç—Ä–æ–º —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Ä–µ–ª–µ"
}

# –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
init() {
    echo "üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GPIO —Å–∏—Å—Ç–µ–º—ã..."
    echo "üìå GPIO –ø–∏–Ω: $POWER_GPIO (—Ñ–∏–∑–∏—á–µ—Å–∫–∏–π pin 12)"
    echo "üìÇ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—É—Ç—å: $POWER_PIN_PATH"
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º GPIO
    init_gpio
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ GPIO $POWER_GPIO —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–≤—ã–∫–ª—é—á–µ–Ω–æ)
        gpio_low
        
        echo "üî¥ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –í–´–ö–õ–Æ–ß–ï–ù–û"
        echo ""
        status
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GPIO $POWER_GPIO"
        return 1
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
case "$1" in
    "on"|"enable"|"start")
        power_on
        ;;
    "off"|"disable"|"stop")
        power_off
        ;;
    "safe-off"|"safe-stop")
        safe_power_off
        ;;
    "status"|"state"|"check")
        status
        ;;
    "test"|"debug")
        test_relay
        ;;
    "init"|"setup")
        init
        ;;
    *)
        echo "üîå –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º Aether Player v3.0"
        echo ""
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {–ö–û–ú–ê–ù–î–ê}"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  on, enable, start     - –í–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏"
        echo "  off, disable, stop    - –í—ã–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏" 
        echo "  safe-off, safe-stop   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å —Å –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º HDD"
        echo "  status, state, check  - –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
        echo "  test, debug          - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É"
        echo "  init, setup          - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å GPIO"
        echo ""
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  $0 init    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å GPIO (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–≤—ã–º)"
        echo "  $0 on      # –í–∫–ª—é—á–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ"
        echo "  $0 status  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
        echo "  $0 test    # –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ª–µ"
        echo ""
        exit 1
        ;;
esac
