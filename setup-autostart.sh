#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° Aether Player Ñ‡ÐµÑ€ÐµÐ· systemd

echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° Aether Player..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
SERVICE_FILE="/etc/systemd/system/aether-player.service"

echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» ÑÐµÑ€Ð²Ð¸ÑÐ°..."
sudo tee "$SERVICE_FILE" > /dev/null << EOF
[Unit]
Description=Aether Player Music Server
After=network.target multi-user.target
Requires=network.target

[Service]
Type=simple
User=eu
Group=eu
WorkingDirectory=/home/eu/aether-player
Environment=PATH=/usr/bin:/usr/local/bin:/home/eu/.local/bin
ExecStartPre=/bin/bash -c 'sleep 10'
ExecStartPre=/home/eu/aether-player/mount-hdd.sh
ExecStart=/usr/bin/python3 -c "import sys; sys.path.insert(0, '.'); from app import app; app.run(host='0.0.0.0', port=5000, debug=False)"
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd
echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd..."
sudo systemctl daemon-reload

# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº
echo "âš¡ Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº..."
sudo systemctl enable aether-player.service

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ..."
sudo systemctl start aether-player.service

# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
sleep 5

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
echo "ðŸ“‹ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°:"
sudo systemctl status aether-player.service --no-pager -l

echo ""
echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ”„ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð¼:"
echo "  - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: sudo systemctl status aether-player"
echo "  - ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ: sudo systemctl stop aether-player"
echo "  - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ: sudo systemctl start aether-player"
echo "  - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ: sudo systemctl restart aether-player"
echo "  - ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº: sudo systemctl disable aether-player"
echo "  - Ð›Ð¾Ð³Ð¸: sudo journalctl -u aether-player -f"
echo ""
echo "ðŸŒ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:"
echo "  http://$(hostname -I | awk '{print $1}'):5000"
echo ""
echo "ðŸ”Œ ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ RPi (sudo reboot) ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
echo "âš¡ Ð”Ð»Ñ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐµÑ€Ð²Ð¸ÑÐ°: sudo systemctl restart aether-player"
